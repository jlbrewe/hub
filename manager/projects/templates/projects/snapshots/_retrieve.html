{% comment %}
A partial for displaying a snapshot (with updating, via polling).

This is a partial mainly because it is self-replacing (see below).

If the snapshot is active then will have `hx-trigger="every 2s"` so that it's status,
results etc get updated. Uses `hx-swap="outerHTML"` so that the trigger
is removed when the snapshot is inactive. Also includes the snapshot as JSON data
in case the enclosing page want to use that data to trigger further events
(e.g. when the snapshot is ended).
{% endcomment %}

{% load i18n humanize stencila %}
{% with files=snapshot.files.all job=snapshot.job project=snapshot.project %}
{% url 'ui-projects-jobs-retrieve' project.account.name project.name job.id  as job_url %}

<div {% if snapshot.is_active %} hx-trigger="every 2s"
     hx-get="{% url 'api-projects-snapshots-detail' project.id snapshot.number %}"
     hx-template="projects/snapshots/_retrieve.html" hx-swap="outerHTML" {% endif %}>

  <div class="level">
    <div class="level-left">
      <h1 class="title">
        Snapshot #{{ snapshot.number }}
      </h1>
    </div>
    {% if job.status == "SUCCESS" %}
    <div class="level-right buttons has-flex-justify-content-end-mobile">
      <a class="button is-small-mobile is-expanded-mobile has-tooltip-bottom has-tooltip-text-centered"
         href="{% url 'api-projects-snapshots-archive' project.id snapshot.number %}">
        <span class="icon">
          <i class="ri-download-line"></i>
        </span>
        <span>
          {% trans "Download" %}
        </span>
      </a>
      {% if snapshot.has_index %}
      <a class="button is-primary is-small-mobile is-expanded-mobile" target="_blank" rel="noopener"
         href="{% url 'api-projects-snapshots-files' project.id snapshot.number 'index.html' %}">
        <span class="icon">
          <i class="ri-external-link-line"></i>
        </span>
        <span>
          {% trans "Open" %}
        </span>
      </a>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <div class="level">
    <div class="level-left">
      {% if job %}
      <div class="job-list--meta mb-2">
        <span>
          <span class="icon is-small is-vcentered pr-1">
            <img src="{{ snapshot.creator.personal_account.image.small }}" role="presentation"></img>
          </span>
          <span class="is-vcentered">
            {{ snapshot.creator.username }}
          </span>
        </span>

        <span alt="{{ job.created }}">
          <span class="icon is-vcentered">
            <i class="ri-calendar-line"></i>
          </span>
          <span class="is-vcentered">
            {{ snapshot.created|naturaltime }}
          </span>
        </span>

        <span class="mr-2">
          <a href="{{ job_url }}">
            {% include "../sources/_status_type_icon.html" with status=job.status %}
            <span>
              {{ job.status }}
            </span>
          </a>
        </span>
      </div>

      {% endif %}
    </div>
  </div>

  {% if snapshot.is_active %}
  {% trans 'Creating snapshot, please waitâ€¦' %}
  {# TODO: Add a progress bar here #}
  {% else %}
  <h2 class="title is-5">Preview</h2>
  {% if snapshot.has_index %}
  <iframe id="frame" class="snapshot--preview"
          src="{% url 'api-projects-snapshots-files' project.id snapshot.number 'index.html' %}">
  </iframe>
  {% else %}
  <p class="is-size-5 has-text-grey-dark">
    {% trans 'A preview is not available for this snapshot. Is there a main file in the project?' %}
  </p>
  {% endif %}

  <hr />

  <h2 class="title is-5">Files</h2>
  {% if files %}
  {% include "../files/_list.html" %}
  {% else %}
  <p class="is-size-5 has-text-grey-dark">
    {% trans 'There are no files in this snapshot' %}
  </p>
  {% endif %}
  {% endif %}
</div>

{% endwith %}
