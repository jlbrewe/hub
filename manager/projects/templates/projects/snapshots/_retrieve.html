{% comment %}
A partial for displaying a snapshot (with updating, via polling).

This is a partial mainly because it is self-replacing (see below).

If the snapshot is active then will have `hx-trigger="every 2s"` so that it's status,
results etc get updated. Uses `hx-swap="outerHTML"` so that the trigger
is removed when the snapshot is inactive. Also includes the snapshot as JSON data
in case the enclosing page want to use that data to trigger further events
(e.g. when the snapshot is ended).
{% endcomment %}

{% load i18n humanize stencila %}
{% with files=snapshot.files.all job=snapshot.job project=snapshot.project %}
{% url 'ui-projects-jobs-retrieve' project.account.name project.name job.id  as job_url %}

<div {% if snapshot.is_active %} hx-trigger="every 2s"
     hx-get="{% url 'api-projects-snapshots-detail' project.id snapshot.id %}"
     hx-template="projects/snapshots/_retrieve.html" hx-swap="outerHTML" {% endif %}>

  <div class="level">
    <div class="level-left">
      <h1 class="title">
        Snapshot {{ snapshot.id }}
        <span class="tag mr-2">
          <a href="{{ job_url }}">
            {% include "../sources/_status_type_icon.html" with status=job.status %}
            <span>
              {{ job.status }}
            </span>
          </a>
        </span>
      </h1>
    </div>
    {% if job.status == "SUCCESS" %}
    <div class="level-right buttons has-flex-justify-content-end-mobile">
      <a class="button is-small-mobile is-expanded-mobile has-tooltip-bottom has-tooltip-text-centered"
         href="{% url 'api-projects-snapshots-archive' project.id snapshot.id %}">
        <span class="icon">
          <i class="ri-download-line"></i>
        </span>
        <span>
          {% trans "Download" %}
        </span>
      </a>
      <a class="button is-primary is-small-mobile is-expanded-mobile"
         href="{% url 'ui-projects-snapshots-view' project.account.name project.name snapshot.id %}">
        <span class="icon">
          <i class="ri-eye-line"></i>
        </span>
        <span>
          {% trans "View" %}
        </span>
      </a>
    </div>
    {% endif %}
  </div>

  <div class="level">
    <div class="level-left">
      {% if job %}
      <div class="job-list--meta mb-2">
        <span>
          <span class="icon is-small is-vcentered pr-1">
            <img src="{{ snapshot.creator.personal_account.image.small }}" role="presentation"></img>
          </span>
          <span class="is-vcentered">
            {{ snapshot.creator.username }}
          </span>
        </span>

        <span alt="{{ job.created }}">
          <span class="icon is-vcentered">
            <i class="ri-calendar-line"></i>
          </span>
          <span class="is-vcentered">
            {{ snapshot.created|naturaltime }}
          </span>
        </span>

        <span alt="Job ID">
          <a href="{{ job_url }}" class="has-text-grey-dark has-text-link-hover">
            <span class="icon is-vcentered">
              <i class="ri-hashtag"></i>
            </span>
            <span class="is-vcentered">
              {{ job.id }}
            </span>
          </a>
        </span>
      </div>

      {% endif %}
    </div>
  </div>

  {# If the snapshot has files, then show them, otherwise show the active job #}
  {% if files %}
  {% include "../files/_list.html" %}
  {% else %}
  <p class="is-size-5 has-text-grey-dark">
    {# TODO Render the job here, so that users have something more interesting to look at and don't have to click away if there is a failure #}
    {% if job.status in "DISPATCHED, RUNNING" %}
    {% trans 'Creating Snapshot, please waitâ€¦' %}
    {% else %}
    The snapshot failed, please see the <a href="{{ job_url }}">job</a> for more details.
    {% endif %}
  </p>
  {% endif %}
</div>

{% endwith %}
